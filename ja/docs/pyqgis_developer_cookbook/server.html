<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>20. QGIS ServerとPython &mdash; QGIS Documentation  ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/qgis_docs.css?v=5415a924" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />

  
    <link rel="shortcut icon" href="../../_static/qgis_logo.ico"/>
    <link rel="canonical" href="https://docs.qgis.org/latest/en/docs/pyqgis_developer_cookbook/server.html"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=c033477b"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script src="../../_static/translations.js?v=4dbe4bdc"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="21. PyQGISチートシート" href="cheat_sheet.html" />
    <link rel="prev" title="19. ネットワーク分析ライブラリ" href="network_analysis.html" />
  <meta name="description" content="QGIS 3.34 documentation: 20. QGIS ServerとPython">
</head>

<body class="wy-body-for-nav">

  <nav class="release_status_topbar">
  </nav>

   

 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
   

          
          
          <a href="../index.html" class="icon icon-home">
            QGIS Documentation
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.34
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
   <a href= "../../genindex.html">Index</a>
 
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ユーザ向け</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/index.html">QGIS Desktopユーザーガイド／マニュアル (QGIS 3.34)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server_manual/index.html">QGIS Serverガイド／マニュアル (QGIS 3.34)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training_manual/index.html">トレーニングマニュアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gentle_gis_introduction/index.html">やさしい GIS 入門</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ドキュメント執筆者向け</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation_guidelines/index.html">ドキュメント作成のガイドライン</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">開発者向け</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">PyQGISクックブック (QGIS 3.34)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">1. はじめに</a></li>
<li class="toctree-l2"><a class="reference internal" href="loadproject.html">2. プロジェクトをロードする</a></li>
<li class="toctree-l2"><a class="reference internal" href="loadlayer.html">3. レイヤをロードする</a></li>
<li class="toctree-l2"><a class="reference internal" href="legend.html">4. 目次（TOC）へのアクセス</a></li>
<li class="toctree-l2"><a class="reference internal" href="raster.html">5. ラスタレイヤを使う</a></li>
<li class="toctree-l2"><a class="reference internal" href="vector.html">6. ベクタレイヤを使う</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometry.html">7. ジオメトリの操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="crs.html">8. 投影法サポート</a></li>
<li class="toctree-l2"><a class="reference internal" href="canvas.html">9. マップキャンバスを使う</a></li>
<li class="toctree-l2"><a class="reference internal" href="composer.html">10. 地図のレンダリングと印刷</a></li>
<li class="toctree-l2"><a class="reference internal" href="expressions.html">11. 式、フィルタ適用および値の算出</a></li>
<li class="toctree-l2"><a class="reference internal" href="settings.html">12. 設定の読み込みと保存</a></li>
<li class="toctree-l2"><a class="reference internal" href="communicating.html">13. ユーザーとコミュニケーションする</a></li>
<li class="toctree-l2"><a class="reference internal" href="authentication.html">14. 認証インフラストラクチャ</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">15. タスク - バックグラウンドで重い仕事をする</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins/index.html">16. Pythonプラグインを開発する</a></li>
<li class="toctree-l2"><a class="reference internal" href="processing.html">17. プロセシングプラグインを書く</a></li>
<li class="toctree-l2"><a class="reference internal" href="pluginlayer.html">18. プラグインレイヤを使う</a></li>
<li class="toctree-l2"><a class="reference internal" href="network_analysis.html">19. ネットワーク分析ライブラリ</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">20. QGIS ServerとPython</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">20.1. はじめに</a></li>
<li class="toctree-l3"><a class="reference internal" href="#server-api-basics">20.2. Server APIの基本</a></li>
<li class="toctree-l3"><a class="reference internal" href="#standalone-or-embedding">20.3. STANDALONE 又は EMBEDDING</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">20.4. サーバー・プラグイン</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#server-filter-plugins">20.4.1. サーバー・フィルター・プラグイン</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-services">20.4.2. カスタムサービス</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-apis">20.4.3. カスタムAPI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cheat_sheet.html">21. PyQGISチートシート</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/index.html">開発者ガイド</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">QGIS Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">PyQGIS 開発者用 Cookbook</a></li>
      <li class="breadcrumb-item active"><span class="section-number">20. </span>QGIS ServerとPython</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/qgis/QGIS-Documentation/blob/master/docs/pyqgis_developer_cookbook/server.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="network_analysis.html" class="btn btn-neutral float-left" title="19. ネットワーク分析ライブラリ" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cheat_sheet.html" class="btn btn-neutral float-right" title="21. PyQGISチートシート" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <blockquote>
<div><div class="admonition important">
<p class="admonition-title">重要</p>
<p>翻訳は <a class="reference external" href="https://qgis.org/en/site/getinvolved/translate.html#becoming-a-translator">あなたが参加できる</a> コミュニティの取り組みです。このページは現在 100.00% 翻訳されています。</p>
</div>
</div></blockquote>
<span class="target" id="index-0"></span><section id="qgis-server-and-python">
<span id="server-plugins"></span><h1><span class="section-number">20. </span>QGIS ServerとPython<a class="headerlink" href="#qgis-server-and-python" title="Link to this heading"></a></h1>
<nav class="contents local" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id5">はじめに</a></p></li>
<li><p><a class="reference internal" href="#server-api-basics" id="id6">Server APIの基本</a></p></li>
<li><p><a class="reference internal" href="#standalone-or-embedding" id="id7">STANDALONE 又は EMBEDDING</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id8">サーバー・プラグイン</a></p>
<ul>
<li><p><a class="reference internal" href="#server-filter-plugins" id="id9">サーバー・フィルター・プラグイン</a></p>
<ul>
<li><p><a class="reference internal" href="#i-o-filters" id="id10">i/O フィルタ</a></p></li>
<li><p><a class="reference internal" href="#access-control-filters" id="id11">アクセス制御フィルタ</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#custom-services" id="id12">カスタムサービス</a></p></li>
<li><p><a class="reference internal" href="#custom-apis" id="id13">カスタムAPI</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">20.1. </span>はじめに</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>QGISサーバーについて更に学ぶには、 <a class="reference internal" href="../server_manual/index.html#qgis-server-manual"><span class="std std-ref">QGIS Server ガイド / マニュアル</span></a> を読んでください。</p>
<p>QGIS Serverは3つの異なるものです:</p>
<ol class="arabic simple">
<li><p>QGIS Serverライブラリ：OGCウェブサービスを作るためのAPIを提供するライブラリ</p></li>
<li><p>QGIS Server FCGI: ウェブサーバーと共にOGCサービス（WMS、WFS、WCSなど）とOGC API (WFS3/OAPIF)を実装するFCGIバイナリアプリケーション <code class="file docutils literal notranslate"><span class="pre">qgis_mapserv.fcgi</span></code></p></li>
<li><p>QGIS開発サーバー: OGCサービス（WMS、WFS、WCSなど）とOGC API (WFS3/OAPIF)を実装した開発サーバーバイナリーアプリケーション <code class="file docutils literal notranslate"><span class="pre">qgis_mapserver</span></code></p></li>
</ol>
<p>クックブックのこの章では、最初のトピックに焦点を当て、QGIS Server API の使用方法を説明することで、Python を使ってサーバーの動作を拡張、強化、カスタマイズする方法や、QGIS Server API を使って QGIS サーバーを別のアプリケーションに組み込む方法を示します。</p>
<p>あなたが直面する可能性のある主なシナリオである、QGIS Serverの動作を変更したり、機能を拡張して新しいカスタムサービスやAPIを提供したりするには、いくつかの方法があります:</p>
<ul class="simple">
<li><p>EMBEDDING → 別のPythonアプリケーションからQGIS Server APIを使用します</p></li>
<li><p>STANDALONE → QGIS ServerをスタンドアロンのWSGI/HTTPサービスとして実行します</p></li>
<li><p>FILTERS → フィルタープラグインでQGISサーバーを強化/カスタマイズします</p></li>
<li><p>SERVICES → 新しい <em>SERVICE</em> を追加します</p></li>
<li><p>OGC APIs → 新しい <em>OGC API</em> を追加します</p></li>
</ul>
<p>埋め込みアプリケーションとスタンドアロンアプリケーションでは、他のPythonスクリプトやアプリケーションからQGIS Server Python APIを直接使用する必要があります。残りのオプションでは、標準のQGIS Serverバイナリアプリケーション（FCGIまたは開発サーバー）にカスタム機能を追加する場合に適しています: この場合、サーバーアプリケーション用のPythonプラグインを書いてカスタムフィルタ、サービス、またはAPIを登録する必要があります。</p>
</section>
<section id="server-api-basics">
<h2><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">20.2. </span>Server APIの基本</a><a class="headerlink" href="#server-api-basics" title="Link to this heading"></a></h2>
<p>典型的なQGIS Serverアプリケーションの基本クラスは以下の通りです:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServer.html#qgis.server.QgsServer" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServer</span></code></a> サーバーのインスタンス（通常はアプリケーション全体で一つのインスタンス）</p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerRequest.html#qgis.server.QgsServerRequest" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerRequest</span></code></a> リクエストオブジェクト（通常はリクエスト毎に再生成されます。）</p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServer.html#qgis.server.QgsServer.handleRequest" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">QgsServer.handleRequest(request,</span> <span class="pre">response)</span></code></a> はリクエストを処理し、レスポンスを生成します</p></li>
</ul>
<p>QGIS Server FCGIまたは開発サーバーのワークフローをまとめると、以下のようになります:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>initialize the QgsApplication
<span class="linenos">2</span>create the QgsServer
<span class="linenos">3</span>the main server loop waits forever for client requests:
<span class="linenos">4</span>    for each incoming request:
<span class="linenos">5</span>        create a QgsServerRequest request
<span class="linenos">6</span>        create a QgsServerResponse response
<span class="linenos">7</span>        call QgsServer.handleRequest(request, response)
<span class="linenos">8</span>            filter plugins may be executed
<span class="linenos">9</span>        send the output to the client
</pre></div>
</div>
<p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServer.html#qgis.server.QgsServer.handleRequest" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">QgsServer.handleRequest(request,</span> <span class="pre">response)</span></code></a> メソッドの内部では、フィルタプラグインのコールバックが呼び出され、 <code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerRequest</span></code> と <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerResponse.html#qgis.server.QgsServerResponse" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerResponse</span></code></a> は <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> クラスを通してプラグインから利用できるようになります。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>QGISサーバークラスはスレッドセーフではないため、QGIS Server APIに基づいたスケーラブルなアプリケーションを構築する場合は、常にマルチプロセッシングモデルまたはコンテナを使用する必要があります。</p>
</div>
</section>
<section id="standalone-or-embedding">
<h2><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">20.3. </span>STANDALONE 又は EMBEDDING</a><a class="headerlink" href="#standalone-or-embedding" title="Link to this heading"></a></h2>
<p>スタンドアロン・サーバー・アプリケーションや組み込みの場合は、上記のサーバー・クラスを直接使用し、クライアントとのすべてのHTTPプロトコルのやり取りを管理するウェブ・サーバー実装にまとめる必要があります。</p>
<p>QGIS Server APIの最小限の使用例（HTTP部分を除く）を以下に示します:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsApplication</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">qgis.server</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 3</span><span class="n">app</span> <span class="o">=</span> <span class="n">QgsApplication</span><span class="p">([],</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="c1"># Create the server instance, it may be a single one that</span>
<span class="linenos"> 6</span><span class="c1"># is reused on multiple requests</span>
<span class="linenos"> 7</span><span class="n">server</span> <span class="o">=</span> <span class="n">QgsServer</span><span class="p">()</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="c1"># Create the request by specifying the full URL and an optional body</span>
<span class="linenos">10</span><span class="c1"># (for example for POST requests)</span>
<span class="linenos">11</span><span class="n">request</span> <span class="o">=</span> <span class="n">QgsBufferServerRequest</span><span class="p">(</span>
<span class="linenos">12</span>    <span class="s1">&#39;http://localhost:8081/?MAP=/qgis-server/projects/helloworld.qgs&#39;</span> <span class="o">+</span>
<span class="linenos">13</span>    <span class="s1">&#39;&amp;SERVICE=WMS&amp;REQUEST=GetCapabilities&#39;</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c1"># Create a response objects</span>
<span class="linenos">16</span><span class="n">response</span> <span class="o">=</span> <span class="n">QgsBufferServerResponse</span><span class="p">()</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="c1"># Handle the request</span>
<span class="linenos">19</span><span class="n">server</span><span class="o">.</span><span class="n">handleRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">())</span>
<span class="linenos">22</span><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="n">app</span><span class="o">.</span><span class="n">exitQgis</span><span class="p">()</span>
</pre></div>
</div>
<p>これは、QGISソースコードリポジトリの継続的な統合テストのために開発された完全なスタンドアロンアプリケーションの例で、さまざまなプラグインフィルタと認証スキームが紹介されています（本番用ではなく、テスト目的のみで開発されていますが、学習には興味深いものです）: <a class="reference external" href="https://github.com/qgis/QGIS/blob/release-3_34/tests/src/python/qgis_wrapped_server.py">qgis_wrapped_server.py</a></p>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">20.4. </span>サーバー・プラグイン</a><a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>Server pythonプラグインは、QGIS Serverアプリケーションの起動時に一度だけロードされ、フィルタ、サービス、またはAPIを登録するために使用できます。</p>
<p>サーバープラグインの構造はデスクトップとよく似ており、<a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> オブジェクトがプラグインに提供され、プラグインはサーバーインターフェースによって公開されるメソッドの1つを使用して、対応するレジストリに1つ以上のカスタムフィルタ、サービス、またはAPIを登録することができます。</p>
<section id="server-filter-plugins">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">20.4.1. </span>サーバー・フィルター・プラグイン</a><a class="headerlink" href="#server-filter-plugins" title="Link to this heading"></a></h3>
<p>フィルタには3つの異なるフレーバーがあり、以下のクラスの1つをサブクラス化し、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> の対応するメソッドを呼び出すことでインスタンス化できます:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>フィルタ型</p></td>
<td><p>ベースクラス</p></td>
<td><p>QgsServerInterface 登録</p></td>
</tr>
<tr class="row-even"><td><p>I/O</p></td>
<td><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerFilter</span></code></a></p></td>
<td><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface.registerFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerFilter()</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p>アクセス制御</p></td>
<td><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsAccessControlFilter</span></code></a></p></td>
<td><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface.registerAccessControl" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerAccessControl()</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p>キャッシュ</p></td>
<td><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerCacheFilter.html#qgis.server.QgsServerCacheFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerCacheFilter</span></code></a></p></td>
<td><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface.registerServerCache" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerServerCache()</span></code></a></p></td>
</tr>
</tbody>
</table>
<section id="i-o-filters">
<h4><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">20.4.1.1. </span>i/O フィルタ</a><a class="headerlink" href="#i-o-filters" title="Link to this heading"></a></h4>
<p>I/Oフィルタは、コアサービス（WMS、WFSなど）のサーバー入力と出力（リクエストとレスポンス）を変更し、サービスのワークフローにあらゆる操作を加えることができます。例えば、選択したレイヤーへのアクセスを制限したり、XMLレスポンスにXSLスタイルシートを注入したり、生成されたWMS画像に透かしを追加したりすることができます。</p>
<p>この時点で、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server">server plugins API docs</a> をざっと見ておくと役に立つかもしれません。</p>
<p>各フィルタは、3つのコールバックのうち少なくとも1つを実装する必要があります:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onRequestReady" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onRequestReady()</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onResponseComplete" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onResponseComplete()</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onSendResponse" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onSendResponse()</span></code></a></p></li>
</ul>
<p>全てのフィルタはリクエスト／レスポンスオブジェクト(<a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsRequestHandler.html#qgis.server.QgsRequestHandler" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsRequestHandler</span></code></a>)にアクセスすることができ、その全てのプロパティ(入力/出力)を操作し、例外を発生させることができます（後述するように、かなり特殊な方法で）。</p>
<p>これらのメソッドはすべて、その呼び出しが後続のフィルタに伝搬されるべきかどうかを示すブール値を返します。これらのメソッドのいずれかが <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code> を返した場合はチェインが停止し、そうでない場合は呼び出しが次のフィルタに伝搬します。</p>
<p>以下は、典型的なリクエストをサーバがどのように処理し、フィルタのコールバックがいつ呼ばれるかを示す擬似コードです:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>for each incoming request:
<span class="linenos"> 2</span>    create GET/POST request handler
<span class="linenos"> 3</span>    pass request to an instance of QgsServerInterface
<span class="linenos"> 4</span>    call onRequestReady filters
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    if there is not a response:
<span class="linenos"> 7</span>        if SERVICE is WMS/WFS/WCS:
<span class="linenos"> 8</span>            create WMS/WFS/WCS service
<span class="linenos"> 9</span>            call service’s executeRequest
<span class="linenos">10</span>                possibly call onSendResponse for each chunk of bytes
<span class="linenos">11</span>                sent to the client by a streaming services (WFS)
<span class="linenos">12</span>        call onResponseComplete
<span class="linenos">13</span>    request handler sends the response to the client
</pre></div>
</div>
<p>次の段落では、利用可能なコールバックを詳細に説明します。</p>
<section id="onrequestready">
<h5><span class="section-number">20.4.1.1.1. </span>onRequestReady<a class="headerlink" href="#onrequestready" title="Link to this heading"></a></h5>
<p>要求の準備ができたときに呼び出されます。受信URLとデータが解析され、コアサービス（WMS、WFSなど）スイッチに入る前に、これは入力を操作するなどのアクションを実行できるポイントです。</p>
<ul class="simple">
<li><p>認証/認可</p></li>
<li><p>リダイレクト</p></li>
<li><p>特定のパラメーター（例えば、型名）を追加／除去</p></li>
<li><p>例外を発生させる</p></li>
</ul>
<p><strong>SERVICE</strong> パラメーターを変更することでコアサービスを完全に置き換え、それによりコアサービスを完全にバイパスすることさえできるかもしれません（とはいえ、これはあまり意味がないということ）。</p>
</section>
<section id="onsendresponse">
<h5><span class="section-number">20.4.1.1.2. </span>onSendResponse<a class="headerlink" href="#onsendresponse" title="Link to this heading"></a></h5>
<p>これは、部分的な出力がレスポンスバッファから(つまり fcgi サーバが使用されている場合は <strong>FCGI</strong> <code class="docutils literal notranslate"><span class="pre">stdout</span></code> に)、さらにそこからクライアントにフラッシュされるたびに呼び出されます。これは（WFSのGetFeatureのように）巨大なコンテンツがストリームされる場合に発生します。この場合、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onSendResponse" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onSendResponse()</span></code></a> が複数回呼び出される可能性があります。</p>
<p>レスポンスがストリームされない場合、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onSendResponse" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onSendResponse()</span></code></a> は全く呼ばれないことに注意してください。</p>
<p>全ての場合において、最後の(あるいはユニークな)チャンクは <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onResponseComplete" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onResponseComplete()</span></code></a> の呼び出しの後にクライアントに送られます。</p>
<p><code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code> を返すと、クライアントへのデータのフラッシュを防ぎます。プラグインがレスポンスから全てのチャンクを収集し、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onResponseComplete" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onResponseComplete()</span></code></a> でレスポンスの検査や変更を行いたい場合、これは望ましいことです。</p>
</section>
<section id="onresponsecomplete">
<h5><span class="section-number">20.4.1.1.3. </span>onResponseComplete<a class="headerlink" href="#onresponsecomplete" title="Link to this heading"></a></h5>
<p>これは、コアサービス（ヒットした場合）が処理を終了し、リクエスト をクライアントに送る準備ができたときに一度だけ呼ばれます。上述したように、このメソッドは最後の（あるいはユニークな）データチャンクがクライアントに送信される前に呼ばれます。ストリーミングサービスの場合、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onSendResponse" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onSendResponse()</span></code></a> への複数の呼び出しが呼び出されている可能性があります。</p>
<p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onResponseComplete" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onResponseComplete()</span></code></a> は、新しいサービスの実装（WPSやカスタムサービス）を提供したり、コアサービスからの出力を直接操作する（例えば、WMS画像に透かしを追加する）のに最適な場所です。</p>
<p><code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code> を返すと、次のプラグインが <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onResponseComplete" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onResponseComplete()</span></code></a> を実行できなくなりますが、いずれにせよ、レスポンスがクライアントに送信されなくなることに注意してください。</p>
</section>
<section id="raising-exceptions-from-a-plugin">
<h5><span class="section-number">20.4.1.1.4. </span>プラグインから例外を発生させる<a class="headerlink" href="#raising-exceptions-from-a-plugin" title="Link to this heading"></a></h5>
<p>このトピックについては、まだいくつかの仕事が残っています: 現在の実装では、QgsMapServiceExceptionのインスタンスに <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsRequestHandler.html#qgis.server.QgsRequestHandler" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsRequestHandler</span></code></a> プロパティを設定することで、処理される例外と処理されない例外を区別することができます。こうすることで、メインのC++コードは、処理されたpythonの例外をキャッチし、処理されなかった例外を無視（またはそれを記録）することができます。</p>
<p>このアプローチは、基本的に動作しますが、それは非常に「パイソン的」ではありません：より良いアプローチは、Pythonコードから例外を発生し、それらがそこで処理されるためにC ++ループに湧き上がるのを見ることでしょう。</p>
</section>
<section id="writing-a-server-plugin">
<span id="index-1"></span><h5><span class="section-number">20.4.1.1.5. </span>サーバー・プラグインを書く<a class="headerlink" href="#writing-a-server-plugin" title="Link to this heading"></a></h5>
<p>サーバプラグインは <a class="reference internal" href="plugins/index.html#developing-plugins"><span class="std std-ref">Pythonプラグインを開発する</span></a> で説明されているような標準的なQGIS Pythonプラグインであり、追加の（あるいは代替の）インターフェースを提供します：一般的なQGISデスクトッププラグインは <code class="xref py py-class docutils literal notranslate"><span class="pre">QgisInterface</span></code> のインスタンスを通してQGISアプリケーションにアクセスすることができますが、サーバプラグインはQGIS Serverアプリケーションコンテキスト内で実行された時のみ <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> にアクセスすることができます。</p>
<p>プラグインがサーバーインターフェイスを持っていることをQGIS Serverに認識させるには、特別なメタデータエントリが（<code class="file docutils literal notranslate"><span class="pre">metadata.txt</span></code> に）必要です:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">server</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p><code class="docutils literal notranslate"><span class="pre">server=True</span></code> のメタデータが設定されているプラグインだけがQGIS Serverに読み込まれ、実行されます。</p>
</div>
<p>ここで説明した <a class="reference external" href="https://github.com/elpaso/qgis3-server-vagrant/tree/master/resources/web/plugins">qgis3-server-vagrant</a> のサンプルプラグインは github で公開されています（他にもたくさんあります）。いくつかのサーバプラグインは公式の <a class="reference external" href="https://plugins.qgis.org/plugins/server">QGIS plugins リポジトリ</a> でも公開されています。</p>
<section id="plugin-files">
<h6><span class="section-number">20.4.1.1.5.1. </span>プラグインファイル<a class="headerlink" href="#plugin-files" title="Link to this heading"></a></h6>
<p>以下は、サーバープラグイン例のディレクトリ構造です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">PYTHON_PLUGINS_PATH</span><span class="o">/</span>
<span class="linenos">2</span>  <span class="n">HelloServer</span><span class="o">/</span>
<span class="linenos">3</span>    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>    <span class="o">--&gt;</span> <span class="o">*</span><span class="n">required</span><span class="o">*</span>
<span class="linenos">4</span>    <span class="n">HelloServer</span><span class="o">.</span><span class="n">py</span>  <span class="o">--&gt;</span> <span class="o">*</span><span class="n">required</span><span class="o">*</span>
<span class="linenos">5</span>    <span class="n">metadata</span><span class="o">.</span><span class="n">txt</span>   <span class="o">--&gt;</span> <span class="o">*</span><span class="n">required</span><span class="o">*</span>
</pre></div>
</div>
<section id="init-py">
<span id="index-2"></span><h6 aria-level="7"><span class="section-number">20.4.1.1.5.1.1. </span>__init__.py<a class="headerlink" href="#init-py" title="Link to this heading"></a></h6>
<p>このファイルはPythonのインポートシステムによって要求されます。また、QGIS Serverはこのファイルに <code class="xref py py-func docutils literal notranslate"><span class="pre">serverClassFactory()</span></code> 関数を含めることを要求します。この関数は、サーバーが開始して、QGIS Serverにプラグインが読み込まれるときに呼び出されます。それは <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> のインスタンスへの参照を受け取り、プラグインのクラスのインスタンスを返す必要があります。プラグインの例 <code class="file docutils literal notranslate"><span class="pre">__init__.py</span></code> はこのようになっています:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">serverClassFactory</span><span class="p">(</span><span class="n">serverIface</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.HelloServer</span> <span class="kn">import</span> <span class="n">HelloServerServer</span>
    <span class="k">return</span> <span class="n">HelloServerServer</span><span class="p">(</span><span class="n">serverIface</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="helloserver-py">
<h6 aria-level="7"><span class="section-number">20.4.1.1.5.1.2. </span>HelloServer.py<a class="headerlink" href="#helloserver-py" title="Link to this heading"></a></h6>
<p>魔法が起こると、これは魔法がどのように見えるかであるところである：（例 <code class="file docutils literal notranslate"><span class="pre">HelloServer.py</span></code> ）</p>
<p>サーバプラグインは通常1つ以上のコールバックで構成され、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerFilter</span></code></a> のインスタンスにパックされます。</p>
<p>各 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerFilter</span></code></a> は以下のコールバックのひとつ以上を実装しています:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onRequestReady" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onRequestReady()</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onResponseComplete" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onResponseComplete()</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerFilter.html#qgis.server.QgsServerFilter.onSendResponse" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onSendResponse()</span></code></a></p></li>
</ul>
<p>次の例は、<strong>SERVICE</strong> パラメーターが &quot;HELLO &quot;に等しい場合に、<em>HelloServer!</em> を印字する最小のフィルタを実施しています:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">HelloFilter</span><span class="p">(</span><span class="n">QgsServerFilter</span><span class="p">):</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
<span class="linenos"> 4</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">serverIface</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="k">def</span> <span class="nf">onRequestReady</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s2">&quot;HelloFilter.onRequestReady&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">def</span> <span class="nf">onSendResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s2">&quot;HelloFilter.onSendResponse&quot;</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="k">def</span> <span class="nf">onResponseComplete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">15</span>        <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s2">&quot;HelloFilter.onResponseComplete&quot;</span><span class="p">)</span>
<span class="linenos">16</span>        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverInterface</span><span class="p">()</span><span class="o">.</span><span class="n">requestHandler</span><span class="p">()</span>
<span class="linenos">17</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parameterMap</span><span class="p">()</span>
<span class="linenos">18</span>        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SERVICE&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;HELLO&#39;</span><span class="p">:</span>
<span class="linenos">19</span>            <span class="n">request</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="linenos">20</span>            <span class="n">request</span><span class="o">.</span><span class="n">setResponseHeader</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
<span class="linenos">21</span>            <span class="c1"># Note that the content is of type &quot;bytes&quot;</span>
<span class="linenos">22</span>            <span class="n">request</span><span class="o">.</span><span class="n">appendBody</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;HelloServer!&#39;</span><span class="p">)</span>
<span class="linenos">23</span>        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>フィルターは、以下の例のように、<strong>serverIface</strong> に登録されなければなりません:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HelloServerServer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
        <span class="n">serverIface</span><span class="o">.</span><span class="n">registerFilter</span><span class="p">(</span><span class="n">HelloFilter</span><span class="p">(</span><span class="n">serverIface</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface.registerFilter" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerFilter())</span></code></a> の2番目のパラメータは、同じ名前のコールバックの順番を定義する優先度を設定します（優先度の低いものが最初に呼び出されます）。</p>
<p>3つのコールバックを使うことで、プラグインは様々な方法でサーバの入力や出力を操作することができます。プラグインのインスタンスはいつでも <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> を通して <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsRequestHandler.html#qgis.server.QgsRequestHandler" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsRequestHandler</span></code></a> にアクセスすることができます。<a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsRequestHandler.html#qgis.server.QgsRequestHandler" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsRequestHandler</span></code></a> クラスには、サーバのコア処理に入る前（:func:<a href="#id1"><span class="problematic" id="id2">`</span></a>requestReady`を使用する）や、リクエストがコアサービスで処理された後（:func:<a href="#id3"><span class="problematic" id="id4">`</span></a>sendResponse`を使用する）に入力パラメータを変更するために使用できるメソッドがたくさんあります。</p>
<p>次の例は、いくつかの一般的なユースケースをカバーします：</p>
</section>
</section>
<section id="modifying-the-input">
<h6><span class="section-number">20.4.1.1.5.2. </span>入力を変更する<a class="headerlink" href="#modifying-the-input" title="Link to this heading"></a></h6>
<p>プラグイン例には、クエリ文字列から来る入力パラメータを変えるテスト例が含まれています。この例では、新しいパラメータが（すでにパースされた）``parameterMap`` に注入され、このパラメータはコアサービス（WMSなど）から見えるようになります：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">ParamsFilter</span><span class="p">(</span><span class="n">QgsServerFilter</span><span class="p">):</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
<span class="linenos"> 4</span>        <span class="nb">super</span><span class="p">(</span><span class="n">ParamsFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">serverIface</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="k">def</span> <span class="nf">onRequestReady</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverInterface</span><span class="p">()</span><span class="o">.</span><span class="n">requestHandler</span><span class="p">()</span>
<span class="linenos"> 8</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parameterMap</span><span class="p">(</span> <span class="p">)</span>
<span class="linenos"> 9</span>        <span class="n">request</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="s1">&#39;TEST_NEW_PARAM&#39;</span><span class="p">,</span> <span class="s1">&#39;ParamsFilter&#39;</span><span class="p">)</span>
<span class="linenos">10</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="k">def</span> <span class="nf">onResponseComplete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">13</span>        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverInterface</span><span class="p">()</span><span class="o">.</span><span class="n">requestHandler</span><span class="p">()</span>
<span class="linenos">14</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parameterMap</span><span class="p">(</span> <span class="p">)</span>
<span class="linenos">15</span>        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TEST_NEW_PARAM&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ParamsFilter&#39;</span><span class="p">:</span>
<span class="linenos">16</span>            <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s2">&quot;SUCCESS - ParamsFilter.onResponseComplete&quot;</span><span class="p">)</span>
<span class="linenos">17</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">18</span>            <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s2">&quot;FAIL    - ParamsFilter.onResponseComplete&quot;</span><span class="p">)</span>
<span class="linenos">19</span>        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>これは、ログファイルに見るものの抽出物である:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span>src/core/qgsmessagelog.cpp:<span class="w"> </span><span class="m">45</span>:<span class="w"> </span><span class="o">(</span>logMessage<span class="o">)</span><span class="w"> </span><span class="o">[</span>0ms<span class="o">]</span><span class="w"> </span><span class="m">2014</span>-12-12T12:39:29<span class="w"> </span>plugin<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>HelloServerServer<span class="w"> </span>-<span class="w"> </span>loading<span class="w"> </span>filter<span class="w"> </span>ParamsFilter
<span class="linenos">2</span><span class="w"> </span>src/core/qgsmessagelog.cpp:<span class="w"> </span><span class="m">45</span>:<span class="w"> </span><span class="o">(</span>logMessage<span class="o">)</span><span class="w"> </span><span class="o">[</span>1ms<span class="o">]</span><span class="w"> </span><span class="m">2014</span>-12-12T12:39:29<span class="w"> </span>Server<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>Server<span class="w"> </span>plugin<span class="w"> </span>HelloServer<span class="w"> </span>loaded!
<span class="linenos">3</span><span class="w"> </span>src/core/qgsmessagelog.cpp:<span class="w"> </span><span class="m">45</span>:<span class="w"> </span><span class="o">(</span>logMessage<span class="o">)</span><span class="w"> </span><span class="o">[</span>0ms<span class="o">]</span><span class="w"> </span><span class="m">2014</span>-12-12T12:39:29<span class="w"> </span>Server<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>Server<span class="w"> </span>python<span class="w"> </span>plugins<span class="w"> </span>loaded
<span class="linenos">4</span><span class="w"> </span>src/mapserver/qgshttprequesthandler.cpp:<span class="w"> </span><span class="m">547</span>:<span class="w"> </span><span class="o">(</span>requestStringToParameterMap<span class="o">)</span><span class="w"> </span><span class="o">[</span>1ms<span class="o">]</span><span class="w"> </span>inserting<span class="w"> </span>pair<span class="w"> </span>SERVICE<span class="w"> </span>//<span class="w"> </span>HELLO<span class="w"> </span>into<span class="w"> </span>the<span class="w"> </span>parameter<span class="w"> </span>map
<span class="linenos">5</span><span class="w"> </span>src/mapserver/qgsserverfilter.cpp:<span class="w"> </span><span class="m">42</span>:<span class="w"> </span><span class="o">(</span>onRequestReady<span class="o">)</span><span class="w"> </span><span class="o">[</span>0ms<span class="o">]</span><span class="w"> </span>QgsServerFilter<span class="w"> </span>plugin<span class="w"> </span>default<span class="w"> </span>onRequestReady<span class="w"> </span>called
<span class="hll"><span class="linenos">6</span><span class="w"> </span>src/core/qgsmessagelog.cpp:<span class="w"> </span><span class="m">45</span>:<span class="w"> </span><span class="o">(</span>logMessage<span class="o">)</span><span class="w"> </span><span class="o">[</span>0ms<span class="o">]</span><span class="w"> </span><span class="m">2014</span>-12-12T12:39:29<span class="w"> </span>plugin<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>SUCCESS<span class="w"> </span>-<span class="w"> </span>ParamsFilter.onResponseComplete
</span></pre></div>
</div>
<p>強調表示された行の「SUCCESS」の文字列は、プラグインがテストに合格したことを示しています。</p>
<p>同じテクニックを使えば、コアサービスの代わりにカスタムサービスを使うこともできます: 例えば、<strong>WFS</strong> <strong>SERVICE</strong> リクエストやその他のコアリクエストを、<strong>SERVICE</strong> パラメータを別のものに変更するだけで、コアサービスをスキップすることができます。そして、カスタム結果を出力に注入してクライアントに送ることができます（これについては後述します）。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>本当にカスタムサービスを実装したい場合は、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsService.html#qgis.server.QgsService" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsService</span></code></a> をサブクラスにして、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface.serviceRegistry" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerFilter()</span></code></a> の <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServiceRegistry.html#qgis.server.QgsServiceRegistry.registerService" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerService(service)</span></code></a> を呼び出してサービスを登録することをお勧めします。</p>
</div>
</section>
<section id="modifying-or-replacing-the-output">
<h6><span class="section-number">20.4.1.1.5.3. </span>出力を変更または置き換えする<a class="headerlink" href="#modifying-or-replacing-the-output" title="Link to this heading"></a></h6>
<p>透かしフィルタの例は、WMSコアサービスによって作成されたWMS画像の上に透かし画像を加算した新たな画像でWMS出力を置き換える方法を示しています：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">qgis.server</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">qgis.PyQt.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">qgis.PyQt.QtGui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span> <span class="nc">WatermarkFilter</span><span class="p">(</span><span class="n">QgsServerFilter</span><span class="p">):</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
<span class="linenos"> 8</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">serverIface</span><span class="p">)</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">def</span> <span class="nf">onResponseComplete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverInterface</span><span class="p">()</span><span class="o">.</span><span class="n">requestHandler</span><span class="p">()</span>
<span class="linenos">12</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parameterMap</span><span class="p">(</span> <span class="p">)</span>
<span class="linenos">13</span>        <span class="c1"># Do some checks</span>
<span class="linenos">14</span>        <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SERVICE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;WMS&#39;</span> \
<span class="linenos">15</span>                <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REQUEST&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GETMAP&#39;</span> \
<span class="linenos">16</span>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">exceptionRaised</span><span class="p">()</span> <span class="p">):</span>
<span class="linenos">17</span>            <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s2">&quot;WatermarkFilter.onResponseComplete: image ready </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">parameter</span><span class="p">(</span><span class="s2">&quot;FORMAT&quot;</span><span class="p">))</span>
<span class="linenos">18</span>            <span class="c1"># Get the image</span>
<span class="linenos">19</span>            <span class="n">img</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">()</span>
<span class="linenos">20</span>            <span class="n">img</span><span class="o">.</span><span class="n">loadFromData</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">())</span>
<span class="linenos">21</span>            <span class="c1"># Adds the watermark</span>
<span class="linenos">22</span>            <span class="n">watermark</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;media/watermark.png&#39;</span><span class="p">))</span>
<span class="linenos">23</span>            <span class="n">p</span> <span class="o">=</span> <span class="n">QPainter</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="linenos">24</span>            <span class="n">p</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">QRect</span><span class="p">(</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">watermark</span><span class="p">)</span>
<span class="linenos">25</span>            <span class="n">p</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
<span class="linenos">26</span>            <span class="n">ba</span> <span class="o">=</span> <span class="n">QByteArray</span><span class="p">()</span>
<span class="linenos">27</span>            <span class="n">buffer</span> <span class="o">=</span> <span class="n">QBuffer</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span>
<span class="linenos">28</span>            <span class="n">buffer</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">QIODevice</span><span class="o">.</span><span class="n">WriteOnly</span><span class="p">)</span>
<span class="linenos">29</span>            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s2">&quot;PNG&quot;</span> <span class="k">if</span> <span class="s2">&quot;png&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">parameter</span><span class="p">(</span><span class="s2">&quot;FORMAT&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;JPG&quot;</span><span class="p">)</span>
<span class="linenos">30</span>            <span class="c1"># Set the body</span>
<span class="linenos">31</span>            <span class="n">request</span><span class="o">.</span><span class="n">clearBody</span><span class="p">()</span>
<span class="linenos">32</span>            <span class="n">request</span><span class="o">.</span><span class="n">appendBody</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span>
<span class="linenos">33</span>        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>この例では、<strong>SERVICE</strong> パラメータ値がチェックされ、受信リクエストが <strong>WMS</strong> <strong>GETMAP</strong> であり、以前に実行されたプラグインまたはコアサービス（この場合はWMS）によって例外が設定されていない場合、WMSによって生成された画像が出力バッファから取得され、透かし画像が追加されます。最後のステップは、出力バッファをクリアし、新しく生成された画像に置き換えることです。実際の状況では、PNGやJPGだけをサポートするのではなく、要求された画像タイプもチェックする必要があることに注意してください。</p>
</section>
</section>
</section>
<section id="access-control-filters">
<h4><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">20.4.1.2. </span>アクセス制御フィルタ</a><a class="headerlink" href="#access-control-filters" title="Link to this heading"></a></h4>
<p>アクセス制御フィルタは、開発者がどのレイヤー、機能、属性にアクセスできるかを細かく制御できるようにします。アクセス制御フィルタには、以下のコールバックを実装できます：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.layerFilterExpression" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">layerFilterExpression(layer)</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.layerFilterSubsetString" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">layerFilterSubsetString(layer)</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.layerPermissions" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">layerPermissions(layer)</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.authorizedLayerAttributes" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">authorizedLayerAttributes(layer,</span> <span class="pre">attributes)</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.allowToEdit" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">allowToEdit(layer,</span> <span class="pre">feature)</span></code></a></p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.cacheKey" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">cacheKey()</span></code></a></p></li>
</ul>
<section id="id3">
<h5><span class="section-number">20.4.1.2.1. </span>プラグインファイル<a class="headerlink" href="#id3" title="Link to this heading"></a></h5>
<p>以下は、プラグイン例のディレクトリ構造です:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>PYTHON_PLUGINS_PATH/
<span class="linenos">2</span>  MyAccessControl/
<span class="linenos">3</span>    __init__.py    --&gt; *required*
<span class="linenos">4</span>    AccessControl.py  --&gt; *required*
<span class="linenos">5</span>    metadata.txt   --&gt; *required*
</pre></div>
</div>
<section id="id4">
<h6><span class="section-number">20.4.1.2.1.1. </span>__init__.py<a class="headerlink" href="#id4" title="Link to this heading"></a></h6>
<p>このファイルはPythonのインポートシステムによって必要とされます。全てのQGISサーバプラグインと同様に、このファイルには <code class="xref py py-func docutils literal notranslate"><span class="pre">serverClassFactory()</span></code> 関数が含まれており、プラグインが起動時にQGIS Serverにロードされる際に呼び出されます。この関数は <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerInterface</span></code></a> のインスタンスへの参照を受け取り、プラグインのクラスのインスタンスを返す必要があります。プラグインの例 <code class="file docutils literal notranslate"><span class="pre">__init__.py</span></code> はこのようになります：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">serverClassFactory</span><span class="p">(</span><span class="n">serverIface</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">MyAccessControl.AccessControl</span> <span class="kn">import</span> <span class="n">AccessControlServer</span>
    <span class="k">return</span> <span class="n">AccessControlServer</span><span class="p">(</span><span class="n">serverIface</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="accesscontrol-py">
<h6><span class="section-number">20.4.1.2.1.2. </span>AccessControl.py<a class="headerlink" href="#accesscontrol-py" title="Link to this heading"></a></h6>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">AccessControlFilter</span><span class="p">(</span><span class="n">QgsAccessControlFilter</span><span class="p">):</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_iface</span><span class="p">):</span>
<span class="linenos"> 4</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_iface</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="k">def</span> <span class="nf">layerFilterExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an additional expression filter &quot;&quot;&quot;</span>
<span class="linenos"> 8</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layerFilterExpression</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">def</span> <span class="nf">layerFilterSubsetString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
<span class="linenos">11</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an additional subset string (typically SQL) filter &quot;&quot;&quot;</span>
<span class="linenos">12</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layerFilterSubsetString</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="k">def</span> <span class="nf">layerPermissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
<span class="linenos">15</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the layer rights &quot;&quot;&quot;</span>
<span class="linenos">16</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layerPermissions</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
<span class="linenos">17</span>
<span class="linenos">18</span>    <span class="k">def</span> <span class="nf">authorizedLayerAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">attributes</span><span class="p">):</span>
<span class="linenos">19</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the authorised layer attributes &quot;&quot;&quot;</span>
<span class="linenos">20</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">authorizedLayerAttributes</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
<span class="linenos">21</span>
<span class="linenos">22</span>    <span class="k">def</span> <span class="nf">allowToEdit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
<span class="linenos">23</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; Are we authorised to modify the following geometry &quot;&quot;&quot;</span>
<span class="linenos">24</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">allowToEdit</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
<span class="linenos">25</span>
<span class="linenos">26</span>    <span class="k">def</span> <span class="nf">cacheKey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">27</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">()</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="k">class</span> <span class="nc">AccessControlServer</span><span class="p">:</span>
<span class="linenos">30</span>
<span class="linenos">31</span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
<span class="linenos">32</span><span class="w">      </span><span class="sd">&quot;&quot;&quot; Register AccessControlFilter &quot;&quot;&quot;</span>
<span class="linenos">33</span>      <span class="n">serverIface</span><span class="o">.</span><span class="n">registerAccessControl</span><span class="p">(</span><span class="n">AccessControlFilter</span><span class="p">(</span><span class="n">serverIface</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>この例では全員に完全なアクセス権を与えています。</p>
<p>誰がログオンしているかを知るのはこのプラグインの役割です。</p>
<p>これらすべての方法で私達は、レイヤーごとの制限をカスタマイズできるようにするには、引数のレイヤーを持っています。</p>
</section>
</section>
<section id="layerfilterexpression">
<h5><span class="section-number">20.4.1.2.2. </span>layerFilterExpression<a class="headerlink" href="#layerfilterexpression" title="Link to this heading"></a></h5>
<p>結果を制限する式を追加するために使用されます。</p>
<p>例えば、属性 <code class="docutils literal notranslate"><span class="pre">role</span></code> が <code class="docutils literal notranslate"><span class="pre">user</span></code> に等しい地物に制限します。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">layerFilterExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;$role = &#39;user&#39;&quot;</span>
</pre></div>
</div>
</section>
<section id="layerfiltersubsetstring">
<h5><span class="section-number">20.4.1.2.3. </span>layerFilterSubsetString<a class="headerlink" href="#layerfiltersubsetstring" title="Link to this heading"></a></h5>
<p>以前よりも同じですが、（データベース内で実行） <code class="docutils literal notranslate"><span class="pre">SubsetString</span></code> を使用</p>
<p>例えば、属性 <code class="docutils literal notranslate"><span class="pre">role</span></code> が <code class="docutils literal notranslate"><span class="pre">user</span></code> に等しい地物に制限します。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">layerFilterSubsetString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;role = &#39;user&#39;&quot;</span>
</pre></div>
</div>
</section>
<section id="layerpermissions">
<h5><span class="section-number">20.4.1.2.4. </span>layerPermissions<a class="headerlink" href="#layerpermissions" title="Link to this heading"></a></h5>
<p>レイヤーへのアクセスを制限します。</p>
<p>プロパティを持つ <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.layerPermissions" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">LayerPermissions()</span></code></a> 型のオブジェクトを返します：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.LayerPermissions.canRead" title="(in QGIS Python API v3.34)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">canRead</span></code></a> で <code class="docutils literal notranslate"><span class="pre">GetCapabilities</span></code> に表示され、読み取りアクセスが可能になります。</p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.LayerPermissions.canInsert" title="(in QGIS Python API v3.34)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">canInsert</span></code></a> で新しい地物を挿入できるようになります。</p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.LayerPermissions.canUpdate" title="(in QGIS Python API v3.34)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">canUpdate</span></code></a> で地物を更新できるようになります。</p></li>
<li><p><a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsAccessControlFilter.html#qgis.server.QgsAccessControlFilter.LayerPermissions.canDelete" title="(in QGIS Python API v3.34)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">canDelete</span></code></a> で地物を削除できるようになります。</p></li>
</ul>
<p>例えば、すべてを読み取り専用アクセスに制限するには：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">layerPermissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">rights</span> <span class="o">=</span> <span class="n">QgsAccessControlFilter</span><span class="o">.</span><span class="n">LayerPermissions</span><span class="p">()</span>
<span class="linenos">3</span>    <span class="n">rights</span><span class="o">.</span><span class="n">canRead</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">4</span>    <span class="n">rights</span><span class="o">.</span><span class="n">canInsert</span> <span class="o">=</span> <span class="n">rights</span><span class="o">.</span><span class="n">canUpdate</span> <span class="o">=</span> <span class="n">rights</span><span class="o">.</span><span class="n">canDelete</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">5</span>    <span class="k">return</span> <span class="n">rights</span>
</pre></div>
</div>
</section>
<section id="authorizedlayerattributes">
<h5><span class="section-number">20.4.1.2.5. </span>authorizedLayerAttributes<a class="headerlink" href="#authorizedlayerattributes" title="Link to this heading"></a></h5>
<p>属性の特定のサブセットの可視性を制限するために使用します。</p>
<p>引数の属性が表示属性の現在のセットを返します。</p>
<p>例えば、<code class="docutils literal notranslate"><span class="pre">role</span></code> 属性を隠します:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">authorizedLayerAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">attributes</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;role&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="allowtoedit">
<h5><span class="section-number">20.4.1.2.6. </span>allowToEdit<a class="headerlink" href="#allowtoedit" title="Link to this heading"></a></h5>
<p>これは、地物のサブセットに編集を制限するために使用されます。</p>
<p>これは、 <code class="docutils literal notranslate"><span class="pre">WFS-Transaction</span></code> プロトコルで使用されています。</p>
<p>例えば、<code class="docutils literal notranslate"><span class="pre">role</span></code> という属性に <code class="docutils literal notranslate"><span class="pre">user</span></code> という値を持つ地物だけを編集できるようにします：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allowToEdit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span>
</pre></div>
</div>
</section>
<section id="cachekey">
<h5><span class="section-number">20.4.1.2.7. </span>cacheKey<a class="headerlink" href="#cachekey" title="Link to this heading"></a></h5>
<p>QGIS Serverは機能のキャッシュを維持し、roleごとにキャッシュを持つには、このメソッドでroleを返します。また、キャッシュを完全に無効にするには <code class="docutils literal notranslate"><span class="pre">None</span></code> を返します。</p>
</section>
</section>
</section>
<section id="custom-services">
<h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">20.4.2. </span>カスタムサービス</a><a class="headerlink" href="#custom-services" title="Link to this heading"></a></h3>
<p>QGIS Serverでは、WMS、WFS、WCSなどのコアサービスは <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsService.html#qgis.server.QgsService" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsService</span></code></a> のサブクラスとして実装されています。</p>
<p>クエリ文字列パラメータ <code class="docutils literal notranslate"><span class="pre">SERVICE</span></code> がサービス名にマッチした時に実行される新しいサービスを実装するには、独自の <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsService.html#qgis.server.QgsService" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsService</span></code></a> を実装し、その <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerInterface.html#qgis.server.QgsServerInterface.serviceRegistry" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerService(service)</span></code></a> を呼び出して <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServiceRegistry.html#qgis.server.QgsServiceRegistry.registerService" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">serviceRegistry()</span></code></a> にサービスを登録します。</p>
<p>以下は <code class="docutils literal notranslate"><span class="pre">CUSTOM</span></code> という名前のカスタムサービスの例です:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">qgis.server</span> <span class="kn">import</span> <span class="n">QgsService</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsMessageLog</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">CustomServiceService</span><span class="p">(</span><span class="n">QgsService</span><span class="p">):</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 7</span>        <span class="n">QgsService</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">10</span>        <span class="k">return</span> <span class="s2">&quot;CUSTOM&quot;</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">13</span>        <span class="k">return</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="k">def</span> <span class="nf">executeRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
<span class="linenos">16</span>        <span class="n">response</span><span class="o">.</span><span class="n">setStatusCode</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="linenos">17</span>        <span class="n">QgsMessageLog</span><span class="o">.</span><span class="n">logMessage</span><span class="p">(</span><span class="s1">&#39;Custom service executeRequest&#39;</span><span class="p">)</span>
<span class="linenos">18</span>        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Custom service executeRequest&quot;</span><span class="p">)</span>
<span class="linenos">19</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="k">class</span> <span class="nc">CustomService</span><span class="p">():</span>
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
<span class="linenos">24</span>        <span class="n">serverIface</span><span class="o">.</span><span class="n">serviceRegistry</span><span class="p">()</span><span class="o">.</span><span class="n">registerService</span><span class="p">(</span><span class="n">CustomServiceService</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="custom-apis">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">20.4.3. </span>カスタムAPI</a><a class="headerlink" href="#custom-apis" title="Link to this heading"></a></h3>
<p>QGIS Serverでは、OAPIF（別名WFS3）のようなコアOGC APIは <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerOgcApiHandler.html#qgis.server.QgsServerOgcApiHandler" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerOgcApiHandler</span></code></a> サブクラスのコレクションとして実装されており、 <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerOgcApi.html#qgis.server.QgsServerOgcApi" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerOgcApi</span></code></a> (またはその親クラス <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerApi.html#qgis.server.QgsServerApi" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerApi</span></code></a>) のインスタンスに登録されます。</p>
<p>urlパスが特定のURLにマッチした時に実行される新しいAPIを実装するには、独自の <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServerOgcApiHandler.html#qgis.server.QgsServerOgcApiHandler" title="(in QGIS Python API v3.34)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerOgcApiHandler</span></code></a> インスタンスを実装し、それらを <code class="xref py py-class docutils literal notranslate"><span class="pre">QgsServerOgcApi</span></code> の <a class="reference external" href="https://qgis.org/pyqgis/3.34/server/QgsServiceRegistry.html#qgis.server.QgsServiceRegistry.registerApi" title="(in QGIS Python API v3.34)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registerApi(api)</span></code></a> を呼び出してAPIを登録します。</p>
<p>以下は、URLに <code class="docutils literal notranslate"><span class="pre">/customapi</span></code> が含まれる場合に実行されるカスタムAPIの例です:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">qgis.PyQt.QtCore</span> <span class="kn">import</span> <span class="n">QBuffer</span><span class="p">,</span> <span class="n">QIODevice</span><span class="p">,</span> <span class="n">QTextStream</span><span class="p">,</span> <span class="n">QRegularExpression</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">qgis.server</span> <span class="kn">import</span> <span class="p">(</span>
<span class="linenos"> 6</span>    <span class="n">QgsServiceRegistry</span><span class="p">,</span>
<span class="linenos"> 7</span>    <span class="n">QgsService</span><span class="p">,</span>
<span class="linenos"> 8</span>    <span class="n">QgsServerFilter</span><span class="p">,</span>
<span class="linenos"> 9</span>    <span class="n">QgsServerOgcApi</span><span class="p">,</span>
<span class="linenos">10</span>    <span class="n">QgsServerQueryStringParameter</span><span class="p">,</span>
<span class="linenos">11</span>    <span class="n">QgsServerOgcApiHandler</span><span class="p">,</span>
<span class="linenos">12</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="p">(</span>
<span class="linenos">15</span>    <span class="n">QgsMessageLog</span><span class="p">,</span>
<span class="linenos">16</span>    <span class="n">QgsJsonExporter</span><span class="p">,</span>
<span class="linenos">17</span>    <span class="n">QgsCircle</span><span class="p">,</span>
<span class="linenos">18</span>    <span class="n">QgsFeature</span><span class="p">,</span>
<span class="linenos">19</span>    <span class="n">QgsPoint</span><span class="p">,</span>
<span class="linenos">20</span>    <span class="n">QgsGeometry</span><span class="p">,</span>
<span class="linenos">21</span><span class="p">)</span>
<span class="linenos">22</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="k">class</span> <span class="nc">CustomApiHandler</span><span class="p">(</span><span class="n">QgsServerOgcApiHandler</span><span class="p">):</span>
<span class="linenos">25</span>
<span class="linenos">26</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">27</span>        <span class="nb">super</span><span class="p">(</span><span class="n">CustomApiHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos">28</span>        <span class="bp">self</span><span class="o">.</span><span class="n">setContentTypes</span><span class="p">([</span><span class="n">QgsServerOgcApi</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">QgsServerOgcApi</span><span class="o">.</span><span class="n">JSON</span><span class="p">])</span>
<span class="linenos">29</span>
<span class="linenos">30</span>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">31</span>        <span class="k">return</span> <span class="n">QRegularExpression</span><span class="p">(</span><span class="s2">&quot;/customapi&quot;</span><span class="p">)</span>
<span class="linenos">32</span>
<span class="linenos">33</span>    <span class="k">def</span> <span class="nf">operationId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">34</span>        <span class="k">return</span> <span class="s2">&quot;CustomApiXYCircle&quot;</span>
<span class="linenos">35</span>
<span class="linenos">36</span>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">37</span>        <span class="k">return</span> <span class="s2">&quot;Creates a circle around a point&quot;</span>
<span class="linenos">38</span>
<span class="linenos">39</span>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">40</span>        <span class="k">return</span> <span class="s2">&quot;Creates a circle around a point&quot;</span>
<span class="linenos">41</span>
<span class="linenos">42</span>    <span class="k">def</span> <span class="nf">linkTitle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">43</span>        <span class="k">return</span> <span class="s2">&quot;Custom Api XY Circle&quot;</span>
<span class="linenos">44</span>
<span class="linenos">45</span>    <span class="k">def</span> <span class="nf">linkType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">46</span>        <span class="k">return</span> <span class="n">QgsServerOgcApi</span><span class="o">.</span><span class="n">data</span>
<span class="linenos">47</span>
<span class="linenos">48</span>    <span class="k">def</span> <span class="nf">handleRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="linenos">49</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple Circle&quot;&quot;&quot;</span>
<span class="linenos">50</span>
<span class="linenos">51</span>        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="linenos">52</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
<span class="linenos">53</span>        <span class="n">y</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="linenos">54</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
<span class="linenos">55</span>        <span class="n">f</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
<span class="linenos">56</span>        <span class="n">f</span><span class="o">.</span><span class="n">setAttributes</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">])</span>
<span class="linenos">57</span>        <span class="n">f</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsCircle</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">toCircularString</span><span class="p">())</span>
<span class="linenos">58</span>        <span class="n">exporter</span> <span class="o">=</span> <span class="n">QgsJsonExporter</span><span class="p">()</span>
<span class="linenos">59</span>        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">exporter</span><span class="o">.</span><span class="n">exportFeature</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span> <span class="n">context</span><span class="p">)</span>
<span class="linenos">60</span>
<span class="linenos">61</span>    <span class="k">def</span> <span class="nf">templatePath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="linenos">62</span>        <span class="c1"># The template path is used to serve HTML content</span>
<span class="linenos">63</span>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;circle.html&#39;</span><span class="p">)</span>
<span class="linenos">64</span>
<span class="linenos">65</span>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="linenos">66</span>        <span class="k">return</span> <span class="p">[</span><span class="n">QgsServerQueryStringParameter</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">QgsServerQueryStringParameter</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">Double</span><span class="p">,</span> <span class="s1">&#39;X coordinate&#39;</span><span class="p">),</span>
<span class="linenos">67</span>                <span class="n">QgsServerQueryStringParameter</span><span class="p">(</span>
<span class="linenos">68</span>                    <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">QgsServerQueryStringParameter</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">Double</span><span class="p">,</span> <span class="s1">&#39;Y coordinate&#39;</span><span class="p">),</span>
<span class="linenos">69</span>                <span class="n">QgsServerQueryStringParameter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">QgsServerQueryStringParameter</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">Double</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">)]</span>
<span class="linenos">70</span>
<span class="linenos">71</span>
<span class="linenos">72</span><span class="k">class</span> <span class="nc">CustomApi</span><span class="p">():</span>
<span class="linenos">73</span>
<span class="linenos">74</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serverIface</span><span class="p">):</span>
<span class="linenos">75</span>        <span class="n">api</span> <span class="o">=</span> <span class="n">QgsServerOgcApi</span><span class="p">(</span><span class="n">serverIface</span><span class="p">,</span> <span class="s1">&#39;/customapi&#39;</span><span class="p">,</span>
<span class="linenos">76</span>                            <span class="s1">&#39;custom api&#39;</span><span class="p">,</span> <span class="s1">&#39;a custom api&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1&#39;</span><span class="p">)</span>
<span class="linenos">77</span>        <span class="n">handler</span> <span class="o">=</span> <span class="n">CustomApiHandler</span><span class="p">()</span>
<span class="linenos">78</span>        <span class="n">api</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="linenos">79</span>        <span class="n">serverIface</span><span class="o">.</span><span class="n">serviceRegistry</span><span class="p">()</span><span class="o">.</span><span class="n">registerApi</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="network_analysis.html" class="btn btn-neutral float-left" title="19. ネットワーク分析ライブラリ" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cheat_sheet.html" class="btn btn-neutral float-right" title="21. PyQGISチートシート" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2002-now, QGIS project.
      <span class="lastupdated">最終更新: 2024 6月 25, 05:29 +0900
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <!-- Transifex follows a particular logic to build target pages:
Expected French translation link for https://docs.qgis.org/3.28/en/docs/user_manual/print_composer/overview_composer.html
would return https://app.transifex.com/qgis/qgis-documentation/translate/#fr/aa6d8bc653526d38b295ca94bf8eee5e
with the md5 value of "github#qgis/QGIS-Documentation#release_3.28#locale/en/LC_MESSAGES/docs/user_manual/print_composer/overview_composer.po"-->
<!--Make sure that mismatching language codes between Transifex and Sphinx are converted-->


  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-info-circle"> QGIS Documentation </span>
      v: 3.34
      <span class="fa fa-caret-down"></span>
    </span>

    <div class="rst-other-versions">
      <dl>
        <dt>Languages</dt>
        
          <dd><a href="https://docs.qgis.org/3.34/en/docs/pyqgis_developer_cookbook/server.html">en</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/cs/docs/pyqgis_developer_cookbook/server.html">cs</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/de/docs/pyqgis_developer_cookbook/server.html">de</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/es/docs/pyqgis_developer_cookbook/server.html">es</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/fr/docs/pyqgis_developer_cookbook/server.html">fr</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/hu/docs/pyqgis_developer_cookbook/server.html">hu</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/it/docs/pyqgis_developer_cookbook/server.html">it</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/ja/docs/pyqgis_developer_cookbook/server.html">ja</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/ko/docs/pyqgis_developer_cookbook/server.html">ko</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/lt/docs/pyqgis_developer_cookbook/server.html">lt</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/nl/docs/pyqgis_developer_cookbook/server.html">nl</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/pt_BR/docs/pyqgis_developer_cookbook/server.html">pt_BR</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/pt_PT/docs/pyqgis_developer_cookbook/server.html">pt_PT</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/ro/docs/pyqgis_developer_cookbook/server.html">ro</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/ru/docs/pyqgis_developer_cookbook/server.html">ru</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/zh-Hans/docs/pyqgis_developer_cookbook/server.html">zh-Hans</a></dd>
        
      </dl>

      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://docs.qgis.org/testing/ja/docs/pyqgis_developer_cookbook/server.html">testing</a></dd>
        
          <dd><a href="https://docs.qgis.org/latest/ja/docs/pyqgis_developer_cookbook/server.html">latest</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/ja/docs/pyqgis_developer_cookbook/server.html">3.34</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.28/ja/docs/pyqgis_developer_cookbook/server.html">3.28</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.22/ja/docs/pyqgis_developer_cookbook/server.html">3.22</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.16/ja/docs/pyqgis_developer_cookbook/server.html">3.16</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.10/ja/docs/pyqgis_developer_cookbook/server.html">3.10</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.4/ja/docs/pyqgis_developer_cookbook/server.html">3.4</a></dd>
        
          <dd><a href="https://docs.qgis.org/2.18/ja/docs/pyqgis_developer_cookbook/server.html">2.18</a></dd>
        
      </dl>

       
       <dl>
        <dt>Downloads</dt>
        
          <dd><a href="https://docs.qgis.org/3.34/pdf">PDF</a></dd>
        
          <dd><a href="https://docs.qgis.org/3.34/zip">HTML</a></dd>
        
      </dl>
      

      
       
      <dl>
        <dt>Contribute to Docs</dt>
          <dd>
            <a href="https://github.com/qgis/QGIS-Documentation/edit/master/docs/pyqgis_developer_cookbook/server.rst" target="_blank" rel="noopener noreferrer">Edit on GitHub</a>
          </dd>
          
          
          <dd>
            <a href="https://app.transifex.com/qgis/qgis-documentation/translate/#ja/eed5c0dbb2811062111890d3c080663b" target="_blank" rel="noopener noreferrer">Translate Page</a>
          </dd>
          
          <dd>
            <a href="https://github.com/qgis/QGIS-Documentation/issues" target="_blank" rel="noopener noreferrer">Report Issue</a>
          </dd>
      </dl>
      

      <dl>
        <dt>On QGIS Project</dt>
          <dd>
            <a href="https://qgis.org/ja" target="_blank" rel="noopener noreferrer">Home</a>
          </dd>
          <dd>
            <a href="https://qgis.org/api/3.34" target="_blank" rel="noopener noreferrer">C++ API</a>
          </dd>
          <dd>
            <a href="https://qgis.org/pyqgis/3.34" target="_blank" rel="noopener noreferrer">PyQGIS API</a>
          </dd>
          <dd>
            <a href="https://github.com/qgis/QGIS/tree/release-3_34" target="_blank" rel="noopener noreferrer">Source</a>
          </dd>
      </dl>

    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>